<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qwen Bio Offline</title>
    <link rel="manifest" href="manifest.json">
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; background: #f4f4f9; }
        #chat-box { height: 400px; overflow-y: scroll; border: 1px solid #ddd; background: #fff; padding: 10px; border-radius: 8px; margin-bottom: 10px; }
        .message { margin: 5px 0; padding: 8px; border-radius: 5px; }
        .user { background: #e3f2fd; text-align: right; }
        .bot { background: #f1f1f1; text-align: left; }
        input { width: 70%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:disabled { background: #ccc; }
        #status { font-size: 0.9em; color: #666; margin-bottom: 10px; }
    </style>
</head>
<body>
    <h2>Qwen Bio (CDN Version)</h2>
    <div id="status">Initializing...</div>
    <div id="chat-box"></div>
    <div style="display: flex; gap: 5px;">
        <input type="text" id="user-input" placeholder="Type a message..." disabled>
        <button id="send-btn" onclick="sendMessage()" disabled>Send</button>
    </div>

    <script type="module">
        // 1. IMPORT FROM CDN (Reliable Public Server)
        import { Wllama } from 'https://cdn.jsdelivr.net/npm/@wllama/wllama/esm/index.js';

        let wllama;
        const statusDiv = document.getElementById('status');
        const inputField = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const chatBox = document.getElementById('chat-box');

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./service-worker.js');
        }

        async function init() {
            statusDiv.innerText = "Loading engine from CDN...";
            
            // 2. CONFIGURE TO USE CDN WASM
            const config = {
                "wllama.wasm": "https://cdn.jsdelivr.net/npm/@wllama/wllama/esm/single-thread/wllama.wasm"
            };
            
            wllama = new Wllama(config);

            statusDiv.innerText = "Downloading Model from HuggingFace...";
            
            try {
                // PASTE YOUR HUGGING FACE LINK BELOW
                const modelUrl = 'https://huggingface.co/YOUR_USERNAME/YOUR_REPO/resolve/main/qwen-bio-q4_k_m.gguf';
                
                await wllama.loadModelFromUrl(modelUrl, {
                    n_ctx: 2048,
                });
                statusDiv.innerText = "âœ… Ready! Offline mode active.";
                inputField.disabled = false;
                sendBtn.disabled = false;
            } catch (e) {
                statusDiv.innerText = "Error loading model. Check console.";
                console.error(e);
            }
        }

        window.sendMessage = async () => {
            const text = inputField.value;
            if (!text) return;

            chatBox.innerHTML += `<div class="message user">${text}</div>`;
            inputField.value = '';
            
            const botDiv = document.createElement('div');
            botDiv.className = 'message bot';
            botDiv.innerText = '...';
            chatBox.appendChild(botDiv);
            chatBox.scrollTop = chatBox.scrollHeight;

            let responseText = "";
            await wllama.createCompletion(text, {
                n_predict: 200,
                sampling: { temp: 0.7, top_k: 40, top_p: 0.9 },
                onNewToken: (token, piece, currentText) => {
                    responseText = currentText;
                    botDiv.innerText = responseText;
                    chatBox.scrollTop = chatBox.scrollHeight;
                }
            });
        };

        init();
    </script>
</body>
</html>
