<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qwen Bio (Online Mode)</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; background: #fff3e0; }
        #status { padding: 15px; background: #fff; border: 2px solid #ff9800; border-radius: 8px; margin-bottom: 20px; font-weight: bold; }
        #chat-box { height: 400px; overflow-y: scroll; background: white; border: 1px solid #ccc; padding: 10px; border-radius: 8px; }
        input { width: 70%; padding: 10px; margin-top: 10px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>⚠️ Cleanup & Repair</h1>
    <div id="status">Initializing Factory Reset...</div>
    <div id="chat-box"></div>
    <input type="text" id="user-input" placeholder="Type here..." disabled>
    <button id="send-btn" onclick="sendMessage()" disabled>Send</button>

    <script type="module">
        import { Wllama } from 'https://cdn.jsdelivr.net/npm/@wllama/wllama@2.3.1/esm/index.js';

        const statusDiv = document.getElementById('status');

        // --- STEP 1: THE KILL SWITCH ---
        // This forces your phone to delete the "Zombie" offline cache
        async function nukeCache() {
            if ('serviceWorker' in navigator) {
                // Unregister all Service Workers
                const registrations = await navigator.serviceWorker.getRegistrations();
                for(let registration of registrations) {
                    console.log('Unregistering SW:', registration);
                    await registration.unregister();
                }
            }
            // Delete all Caches
            const keys = await caches.keys();
            for (let key of keys) {
                console.log('Deleting Cache:', key);
                await caches.delete(key);
            }
            console.log('✅ CLEANUP COMPLETE');
        }

        async function init() {
            statusDiv.innerText = "⏳ 1. Deleting old broken files...";
            await nukeCache();
            
            statusDiv.innerText = "⏳ 2. Downloading Engine (Fresh)...";
            
            try {
                // Use the Single-Thread WASM explicitly
                const wllama = new Wllama({
                    "wllama.wasm": "https://cdn.jsdelivr.net/npm/@wllama/wllama@2.3.1/esm/single-thread/wllama.wasm"
                });

                statusDiv.innerText = "⏳ 3. Downloading Your Model...";
                
                // YOUR MODEL LINK
                const modelUrl = 'https://huggingface.co/aibinshibuc/my-qwen-offline/resolve/main/qwen-bio-q4_k_m.gguf';
                
                await wllama.loadModelFromUrl(modelUrl, { n_ctx: 2048 });
                
                statusDiv.innerText = "✅ FIXED! The AI is working.";
                statusDiv.style.borderColor = "green";
                statusDiv.style.background = "#e8f5e9";
                document.getElementById('user-input').disabled = false;
                document.getElementById('send-btn').disabled = false;

                window.wllama_instance = wllama; // Save for chatting

            } catch (e) {
                statusDiv.innerText = "❌ Error: " + e.message;
                console.error(e);
            }
        }

        window.sendMessage = async () => {
            const input = document.getElementById('user-input');
            const chatBox = document.getElementById('chat-box');
            const text = input.value;
            if (!text) return;

            chatBox.innerHTML += `<div style="text-align:right; margin:10px; background:#e3f2fd; padding:8px; border-radius:5px;">${text}</div>`;
            input.value = '';

            const response = await window.wllama_instance.createCompletion(text, { n_predict: 200 });
            
            chatBox.innerHTML += `<div style="text-align:left; margin:10px; background:#f5f5f5; padding:8px; border-radius:5px;">${response}</div>`;
            chatBox.scrollTop = chatBox.scrollHeight;
        };

        init();
    </script>
</body>
</html>
